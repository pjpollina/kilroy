#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path(File.dirname(__FILE__)).chomp('/bin')

require 'dotenv/load'
require 'discordrb'
require 'lib/kilroy'
require 'lib/utils/backup'
require 'lib/clients/mysql'
require 'lib/clients/tweeter'
require 'lib/channels/status'
require 'lib/channels/cardio'

kilroy = Kilroy.new(
  mysql:   MySQL.new('kilroy', ENV['discord_bot_token'], 'fitness', ENV['sql_host'] || 'localhost'),
  discord: Discordrb::Bot.new(token: ENV['discord_bot_token'], client_id:  ENV['discord_bot_id']),
  tweeter: Tweeter.new
)

kilroy.message(in: '#cardio') do |event|
  response, error = Cardio.insert(event.content, kilroy.mysql)
  event.respond(response) if error
  puts "#{"Error in #cardio: " if error}#{response}"
end

kilroy.message(in: '#status') do |event|
  response, log = Status.response(event.content, kilroy.mysql)
  event.respond(response) unless response.empty?
  puts ((log.nil?) ? "Command error: #{response}" : log)
end

kilroy.message(in: '#general') do |event|
  if(event.content.eql?('tweet'))
    event.respond(tweeter.day_totals(mysql))
  elsif(event.content.eql?('sync s3'))
    Backup.s3_sync
    puts 's3 synced'
  end
end

kilroy.run
